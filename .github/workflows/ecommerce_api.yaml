name: Ecommerce API tests

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      deployment_target:
        description: Choose target
        required: true
        default: all_tests
        type: choice
        options:
          - all_tests
          - auth_tests
          - first_tests
          - negative_tests
          - regression_tests
          - positive_tests
          - smoke_tests
          - users_tests

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Create .env file
        run: |
          cat > .env << EOF
          USER=${{ secrets.USER }}
          PASSWORD=${{ secrets.PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          HOST=${{ secrets.HOST }}
          PORT=${{ secrets.PORT }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          EOF
          
          echo "Database host: ${{ secrets.HOST }}"
          echo "Database port: ${{ secrets.PORT }}"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Simple network test
        run: |
          echo "Testing database connectivity..."
          
          python -c "
          import os
          from dotenv import load_dotenv
          load_dotenv()
          
          host = os.getenv('HOST')
          port = os.getenv('PORT')
          user = os.getenv('USER')
          dbname = os.getenv('DB_NAME')
          password = os.getenv('PASSWORD')
          
          print(f'Trying to connect to PostgreSQL at {host}:{port}...')
          
          # Сначала проверяем базовую TCP доступность
          import socket
          sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          sock.settimeout(10)
          
          try:
              result = sock.connect_ex((host, int(port)))
              if result == 0:
                  print('✅ TCP connection to port successful')
              else:
                  print(f'❌ TCP connection failed with code: {result}')
                  print('This means:')
                  if result == 111:
                      print('  - Server is not listening on port {port}')
                      print('  - Firewall is blocking the port')
                      print('  - Service is not running')
                  elif result == 110:
                      print('  - Connection timeout')
                      print('  - Server might be behind firewall that drops packets')
                  elif result == 113:
                      print('  - No route to host')
                      print('  - Host is down or unreachable')
                  exit(1)
          except Exception as e:
              print(f'❌ Socket error: {e}')
              exit(1)
          finally:
              sock.close()
          
          # Теперь пробуем подключиться через psycopg2
          print('\\nTrying PostgreSQL connection...')
          try:
              import psycopg2
              conn = psycopg2.connect(
                  host=host,
                  port=int(port),
                  database=dbname,
                  user=user,
                  password=password,
                  connect_timeout=15
              )
              print('✅ PostgreSQL connection successful!')
              
              # Проверяем версию
              cur = conn.cursor()
              cur.execute('SELECT version();')
              version = cur.fetchone()[0]
              print(f'PostgreSQL version: {version}')
              
              # Проверяем существующие таблицы
              cur.execute(\"\"\"
                  SELECT table_name 
                  FROM information_schema.tables 
                  WHERE table_schema = 'public'
              \"\"\")
              tables = [row[0] for row in cur.fetchall()]
              print(f'Found {len(tables)} tables: {tables}')
              
              conn.close()
              print('✅ All database checks passed')
              
          except psycopg2.OperationalError as e:
              print(f'❌ PostgreSQL connection failed: {e}')
              print('\\nPossible causes:')
              print('1. Wrong credentials')
              print('2. Database does not exist')
              print('3. User does not have permission')
              print('4. SSL/TLS issues')
              exit(1)
          except Exception as e:
              print(f'❌ Unexpected error: {e}')
              exit(1)
          "

      - name: Clean test data
        run: |
          echo "Cleaning existing test data..."
          python -c "
          import os
          from dotenv import load_dotenv
          load_dotenv()
          
          import psycopg2
          
          try:
              conn = psycopg2.connect(
                  host=os.getenv('HOST'),
                  port=int(os.getenv('PORT')),
                  database=os.getenv('DB_NAME'),
                  user=os.getenv('USER'),
                  password=os.getenv('PASSWORD'),
                  connect_timeout=10
              )
              conn.autocommit = True
              cur = conn.cursor()
              
              # Удаляем ВСЕХ тестовых пользователей
              cur.execute(\"DELETE FROM users WHERE email LIKE '%test%' OR email LIKE '%@example.com' OR email LIKE 'test_%'\")
              deleted = cur.rowcount
              print(f'Deleted {deleted} test users')
              
              # Также очищаем tokens
              try:
                  cur.execute(\"DELETE FROM tokens\")
                  print(f'Deleted {cur.rowcount} tokens')
              except:
                  print('No tokens table or error cleaning tokens')
              
              conn.close()
          except Exception as e:
              print(f'Cleanup error (continuing anyway): {e}')
          "

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "Running tests..."
          
          if [[ \"${{ github.event_name }}\" == \"push\" || \"${{ github.event_name }}\" == \"pull_request\" ]]; then
            python -m pytest -v --tb=short --alluredir=allure-results
          else
            TARGET=\"${{ github.event.inputs.deployment_target }}\"
            
            case \$TARGET in
              \"all_tests\")
                python -m pytest -v --tb=short --alluredir=allure-results
                ;;
              \"auth_tests\")
                python -m pytest -v --tb=short -m auth --alluredir=allure-results
                ;;
              \"first_tests\")
                python -m pytest -v --tb=short -m first --alluredir=allure-results
                ;;
              \"negative_tests\")
                python -m pytest -v --tb=short -m negative --alluredir=allure-results
                ;;
              \"regression_tests\")
                python -m pytest -v --tb=short -m regression --alluredir=allure-results
                ;;
              \"positive_tests\")
                python -m pytest -v --tb=short -m positive --alluredir=allure-results
                ;;
              \"smoke_tests\")
                python -m pytest -v --tb=short -m smoke --alluredir=allure-results
                ;;
              \"users_tests\")
                python -m pytest -v --tb=short -m users --alluredir=allure-results
                ;;
            esac
          fi

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results
          retention-days: 1

  publish-report:
    runs-on: ubuntu-latest
    needs: run-tests
    if: always()

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download Allure results artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Get Allure history
        uses: actions/checkout@v5
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          keep_reports: 20

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history