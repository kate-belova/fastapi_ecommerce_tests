name: Ecommerce API tests

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      deployment_target:
        description: Choose target
        required: true
        default: all_tests
        type: choice
        options:
          - all_tests
          - auth_tests
          - first_tests
          - negative_tests
          - regression_tests
          - positive_tests
          - smoke_tests
          - users_tests

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Debug secrets
        run: |
          echo "=== Checking GitHub Secrets ==="
          echo "HOST exists: ${{ secrets.HOST != '' && 'YES' || 'NO' }}"
          echo "PORT exists: ${{ secrets.PORT != '' && 'YES' || 'NO' }}"
          echo "USER exists: ${{ secrets.USER != '' && 'YES' || 'NO' }}"
          echo "DB_NAME exists: ${{ secrets.DB_NAME != '' && 'YES' || 'NO' }}"
          echo "SECRET_KEY exists: ${{ secrets.SECRET_KEY != '' && 'YES' || 'NO' }}"
          
          # Проверяем длины (скрывая значения)
          USER_LEN=${#USER_SECRET}
          PASSWORD_LEN=${#PASSWORD_SECRET}
          echo "USER length: $USER_LEN"
          echo "PASSWORD length: $PASSWORD_LEN"
          
          if [ $USER_LEN -eq 0 ]; then
            echo "ERROR: USER secret is empty!"
            exit 1
          fi
        env:
          USER_SECRET: ${{ secrets.USER }}
          PASSWORD_SECRET: ${{ secrets.PASSWORD }}

      - name: Create .env file
        run: |
          echo "Creating .env file..."
          
          # Записываем переменные в .env
          echo "USER=$DB_USER" > .env
          echo "PASSWORD=$DB_PASSWORD" >> .env
          echo "DB_NAME=$DB_NAME" >> .env
          echo "HOST=$HOST" >> .env
          echo "PORT=$PORT" >> .env
          echo "SECRET_KEY=$SECRET_KEY" >> .env
          
          # Проверяем что файл создан
          echo "=== .env file created ==="
          echo "Lines in .env: $(wc -l < .env)"
          echo "First few chars of USER: $(head -1 .env | cut -d'=' -f2 | head -c 5)..."
        env:
          DB_USER: ${{ secrets.USER }}
          DB_PASSWORD: ${{ secrets.PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          HOST: ${{ secrets.HOST }}
          PORT: ${{ secrets.PORT }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Test config loading
        run: |
          echo "Testing if config.py loads correctly..."
          
          # Сначала проверяем .env
          echo "=== .env file ==="
          cat .env | while read line; do
            if [[ $line == *"PASSWORD"* ]] || [[ $line == *"SECRET_KEY"* ]]; then
              echo "${line%%=*}=[HIDDEN]"
            else
              echo "$line"
            fi
          done
          
          # Теперь проверяем config.py
          echo ""
          echo "=== Testing config.py ==="
          python -c "
          # Временно изменяем config.py для вывода отладочной информации
          import os
          print('Current working directory:', os.getcwd())
          print('Files in current dir:', os.listdir('.'))
          print('Files in database dir:', os.listdir('database') if os.path.exists('database') else 'No database dir')
          
          # Импортируем config
          try:
              from database import config
              print('✅ Successfully imported config')
              
              # Проверяем переменные
              print('USER from config (via os.getenv):', os.getenv('USER'))
              print('HOST from config (via os.getenv):', os.getenv('HOST'))
              print('DATABASE_URL first 50 chars:', config.DATABASE_URL[:50] + '...')
              
              # Проверяем что USER не 'runner'
              user = os.getenv('USER')
              if user == 'runner':
                  print('❌ ERROR: USER is "runner" (default value)')
                  print('This means the environment variable is not set!')
                  exit(1)
              elif user == 'ecommerce_user':
                  print('✅ USER is correct: ecommerce_user')
              else:
                  print(f'⚠️ USER is: {user}')
                  
          except Exception as e:
              print(f'❌ Failed to import config: {e}')
              import traceback
              traceback.print_exc()
          "

      - name: Test database connection
        env:
          # Передаем переменные напрямую для этого шага
          USER: ${{ secrets.USER }}
          PASSWORD: ${{ secrets.PASSWORD }}
          HOST: ${{ secrets.HOST }}
          PORT: ${{ secrets.PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          echo "=== Direct database connection test ==="
          
          python -c "
          import os
          
          print('Environment variables for this step:')
          print('USER:', os.getenv('USER'))
          print('HOST:', os.getenv('HOST'))
          print('PORT:', os.getenv('PORT'))
          print('DB_NAME:', os.getenv('DB_NAME'))
          print('PASSWORD length:', len(os.getenv('PASSWORD', '')))
          
          # Проверяем что это наш пользователь
          user = os.getenv('USER')
          if user != 'ecommerce_user':
              print(f'❌ ERROR: Expected USER=ecommerce_user, but got: {user}')
              print('This means GitHub Secrets are not being passed correctly!')
              exit(1)
          
          import psycopg2
          try:
              conn = psycopg2.connect(
                  host=os.getenv('HOST'),
                  port=int(os.getenv('PORT')),
                  database=os.getenv('DB_NAME'),
                  user=os.getenv('USER'),
                  password=os.getenv('PASSWORD'),
                  connect_timeout=10
              )
              print('✅ PostgreSQL connection successful!')
              print(f'Connected as user: {os.getenv(\"USER\")}')
              
              cur = conn.cursor()
              cur.execute('SELECT current_user;')
              current_user = cur.fetchone()[0]
              print(f'Current database user: {current_user}')
              
              conn.close()
          except psycopg2.OperationalError as e:
              print(f'❌ Connection failed: {e}')
              exit(1)
          "

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
          # Передаем переменные напрямую для тестов
          USER: ${{ secrets.USER }}
          PASSWORD: ${{ secrets.PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          HOST: ${{ secrets.HOST }}
          PORT: ${{ secrets.PORT }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "=== Environment for tests ==="
          echo "USER: $USER"
          echo "HOST: $HOST"
          echo "PORT: $PORT"
          
          if [[ \"${{ github.event_name }}\" == \"push\" || \"${{ github.event_name }}\" == \"pull_request\" ]]; then
            python -m pytest -v --tb=short --alluredir=allure-results
          else
            TARGET=\"${{ github.event.inputs.deployment_target }}\"
            case \$TARGET in
              \"all_tests\") python -m pytest -v --tb=short --alluredir=allure-results ;;
              \"auth_tests\") python -m pytest -v --tb=short -m auth --alluredir=allure-results ;;
              \"first_tests\") python -m pytest -v --tb=short -m first --alluredir=allure-results ;;
              \"negative_tests\") python -m pytest -v --tb=short -m negative --alluredir=allure-results ;;
              \"regression_tests\") python -m pytest -v --tb=short -m regression --alluredir=allure-results ;;
              \"positive_tests\") python -m pytest -v --tb=short -m positive --alluredir=allure-results ;;
              \"smoke_tests\") python -m pytest -v --tb=short -m smoke --alluredir=allure-results ;;
              \"users_tests\") python -m pytest -v --tb=short -m users --alluredir=allure-results ;;
            esac
          fi

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results
          retention-days: 1